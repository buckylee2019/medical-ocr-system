# üöÄ AWS App Runner Deployment Guide - Medical OCR System

## üìã Overview

This guide provides step-by-step instructions for deploying the Medical OCR System to **AWS App Runner** - the simplest and most cost-effective deployment option for this application.

## üéØ Why App Runner?

**‚úÖ Advantages:**
- **Fully managed service** - No server management required
- **Automatic scaling** - Scales up/down based on traffic
- **Built-in load balancing** - High availability out of the box
- **Easy CI/CD integration** - Automatic deployments from GitHub
- **Cost-effective** - Pay only for what you use (~$25-40/month)
- **Perfect for Flask apps** - Designed for web applications

**üìä Cost Estimate:**
- **App Runner**: ~$25/month (1 vCPU, 2GB RAM)
- **DynamoDB**: ~$1-5/month (based on usage)
- **S3**: ~$1-3/month (image storage)
- **Bedrock**: Pay-per-API-call
- **Total**: ~$30-40/month

## üöÄ Quick Deployment (5 Steps)

### Step 1: Prepare AWS Resources
```bash
# Run the quick setup script
cd deploy
./quick_deploy.sh
```

This script will create:
- ‚úÖ S3 bucket for image storage
- ‚úÖ DynamoDB table for data
- ‚úÖ IAM role with proper permissions
- ‚úÖ App Runner configuration file

### Step 2: Push Code to GitHub
```bash
# Initialize git repository (if not already done)
git init
git add .
git commit -m "Initial commit"

# Push to GitHub
git remote add origin https://github.com/YOUR_USERNAME/medical-ocr.git
git push -u origin main
```

### Step 3: Create App Runner Service
1. Go to [AWS App Runner Console](https://console.aws.amazon.com/apprunner/)
2. Click **"Create service"**
3. Choose **"Source code repository"**
4. Connect your GitHub account
5. Select your repository and branch (main)

### Step 4: Configure Service
**Repository settings:**
- **Configuration source**: Use configuration file
- **Configuration file**: `apprunner.yaml` (auto-generated)

**Service settings:**
- **Service name**: `medical-ocr-app`
- **Instance role**: Select the created IAM role
- **Auto-scaling**: Default settings (25-100 instances)

### Step 5: Deploy and Test
1. Click **"Create & deploy"**
2. Wait for deployment (5-10 minutes)
3. Test your application:
   - Health check: `https://your-app-url/health`
   - Main app: `https://your-app-url/`

## üìÅ App Runner Configuration

The `apprunner.yaml` file (auto-generated by quick_deploy.sh):

```yaml
version: 1.0
runtime: python3
build:
  commands:
    build:
      - echo "Installing dependencies"
      - pip install -r requirements.txt
run:
  runtime-version: 3.11
  command: python app.py
  network:
    port: 5006
  env:
    - name: AWS_DEFAULT_REGION
      value: us-west-2
    - name: DYNAMODB_TABLE_NAME
      value: medical-ocr-data
    - name: S3_BUCKET
      value: your-medical-ocr-bucket
    - name: FLASK_ENV
      value: production
```

## üîê Security Configuration

### IAM Role Permissions
The deployment script creates an IAM role with these permissions:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "dynamodb:GetItem",
        "dynamodb:PutItem", 
        "dynamodb:UpdateItem",
        "dynamodb:DeleteItem",
        "dynamodb:Scan",
        "dynamodb:Query"
      ],
      "Resource": "arn:aws:dynamodb:*:*:table/medical-ocr-data"
    },
    {
      "Effect": "Allow",
      "Action": [
        "s3:GetObject",
        "s3:PutObject",
        "s3:DeleteObject"
      ],
      "Resource": "arn:aws:s3:::your-bucket/*"
    },
    {
      "Effect": "Allow",
      "Action": [
        "bedrock:InvokeModel",
        "bedrock:ListFoundationModels"
      ],
      "Resource": "*"
    }
  ]
}
```

### Environment Variables
Set these in the App Runner console:
```bash
AWS_DEFAULT_REGION=us-west-2
DYNAMODB_TABLE_NAME=medical-ocr-data
S3_BUCKET=your-medical-ocr-bucket
FLASK_ENV=production
FLASK_DEBUG=False
```

## üìä Monitoring and Health Checks

### Built-in Health Check
Your app includes a health check endpoint at `/health`:

```json
{
  "status": "healthy",
  "version": "1.2.0",
  "services": {
    "dynamodb": "ok",
    "s3": "ok",
    "bedrock": "ok"
  }
}
```

### CloudWatch Integration
App Runner automatically integrates with CloudWatch:
- **Application logs**: `/aws/apprunner/medical-ocr/application`
- **Service logs**: `/aws/apprunner/medical-ocr/service`

### Set Up Alarms
```bash
# High error rate alarm
aws cloudwatch put-metric-alarm \
  --alarm-name "medical-ocr-high-error-rate" \
  --alarm-description "High error rate in medical OCR app" \
  --metric-name "4XXError" \
  --namespace "AWS/AppRunner" \
  --statistic Sum \
  --period 300 \
  --threshold 10 \
  --comparison-operator GreaterThanThreshold
```

## üîß Customization Options

### Custom Domain
1. Go to App Runner console
2. Select your service
3. Go to **"Custom domains"** tab
4. Add your domain and configure DNS

### Auto-scaling Settings
```yaml
# Add to apprunner.yaml
auto-scaling-configuration:
  max-concurrency: 100
  max-size: 25
  min-size: 1
```

### Instance Configuration
```yaml
# Add to apprunner.yaml
instance-configuration:
  cpu: 1024      # 1 vCPU
  memory: 2048   # 2 GB RAM
```

## üîÑ CI/CD Pipeline

App Runner provides automatic deployments:

1. **Push to GitHub** ‚Üí Automatic deployment
2. **Manual deployment** ‚Üí App Runner console
3. **Rollback** ‚Üí Previous version in console

### Deployment Settings
- **Automatic deployments**: Enabled by default
- **Branch**: main (configurable)
- **Build timeout**: 20 minutes
- **Health check grace period**: 120 seconds

## üêõ Troubleshooting

### Common Issues

#### 1. Deployment Fails
```bash
# Check build logs in App Runner console
# Common causes:
# - Missing dependencies in requirements.txt
# - Python version mismatch
# - Environment variables not set
```

#### 2. Health Check Fails
```bash
# Test health endpoint locally
curl http://localhost:5006/health

# Check AWS service permissions
# Verify environment variables
```

#### 3. Bedrock Access Denied
```bash
# Enable Bedrock model access in AWS console
# Check IAM role permissions
# Verify region settings
```

### Debug Commands
```bash
# View App Runner service details
aws apprunner describe-service --service-arn <your-service-arn>

# Check recent deployments
aws apprunner list-operations --service-arn <your-service-arn>

# View logs
aws logs tail /aws/apprunner/medical-ocr/application --follow
```

## üìã Deployment Checklist

### Pre-deployment
- [ ] AWS credentials configured (`aws configure`)
- [ ] GitHub repository created and accessible
- [ ] Code tested locally (`python app.py`)
- [ ] Environment variables prepared

### Deployment
- [ ] Run `./quick_deploy.sh` successfully
- [ ] GitHub repository connected to App Runner
- [ ] Service created with correct configuration
- [ ] IAM role assigned to service
- [ ] Environment variables set

### Post-deployment
- [ ] Health check endpoint responding (`/health`)
- [ ] Main application accessible
- [ ] Image upload and processing working
- [ ] Medical details display functioning
- [ ] CloudWatch logs flowing

### Optional
- [ ] Custom domain configured
- [ ] CloudWatch alarms set up
- [ ] Backup strategy implemented
- [ ] Performance testing completed

## üéØ Next Steps After Deployment

1. **Test All Features**:
   - Upload medical documents
   - Test OCR processing
   - Verify human review workflow
   - Check medical details display

2. **Set Up Monitoring**:
   - Configure CloudWatch alarms
   - Set up notification channels
   - Monitor performance metrics

3. **Optimize Performance**:
   - Monitor response times
   - Adjust auto-scaling settings
   - Optimize image processing

4. **Security Review**:
   - Review IAM permissions
   - Enable AWS CloudTrail
   - Set up VPC (if needed)

5. **Backup Strategy**:
   - Configure DynamoDB backups
   - Set up S3 versioning
   - Document recovery procedures

## üí° Tips for Success

- **Start Small**: Deploy with minimal configuration first
- **Monitor Costs**: Use AWS Cost Explorer to track expenses
- **Test Thoroughly**: Verify all features work in production
- **Keep It Simple**: App Runner handles most infrastructure concerns
- **Use Health Checks**: Monitor service health continuously

---

**üéâ Congratulations!** Your Medical OCR System is now running on AWS App Runner with full UI support, automatic scaling, and production-ready configuration.

**Support Resources:**
- [AWS App Runner Documentation](https://docs.aws.amazon.com/apprunner/)
- [AWS Support](https://aws.amazon.com/support/)
- [CloudWatch Logs](https://console.aws.amazon.com/cloudwatch/)
